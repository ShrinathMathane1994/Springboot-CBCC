CREATE TABLE test_cases (
    idtc SERIAL PRIMARY KEY,
    tc_name VARCHAR(255),
    description TEXT,
    feature_scenario_json TEXT,
    input_file VARCHAR(500),
    output_file VARCHAR(500),
    created_on TIMESTAMP,
    modified_on TIMESTAMP,
    last_run_on TIMESTAMP,
    last_run_status VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    country VARCHAR(100),
    region VARCHAR(100),
    pod VARCHAR(100)
);
----------------------


CREATE TABLE test_case_history (
    id SERIAL PRIMARY KEY,
    test_case_id INT NOT NULL,
    tc_name VARCHAR(255),
    description TEXT,
    feature_scenario_json TEXT,
    input_file VARCHAR(500),
    output_file VARCHAR(500),
    modified_on TIMESTAMP,
    change_type VARCHAR(50),
    country VARCHAR(100),
    region VARCHAR(100),
    pod VARCHAR(100),
    CONSTRAINT fk_history_test_case
        FOREIGN KEY (test_case_id)
        REFERENCES test_cases(idtc)
        ON DELETE CASCADE
);


------------------------

CREATE TABLE test_case_run_history (
    id SERIAL PRIMARY KEY,
    test_case_id INT NOT NULL,
    run_on TIMESTAMP,
    run_status VARCHAR(100),
    output_log TEXT,
    executed_scenarios TEXT,
    unexecuted_scenarios TEXT,
    raw_log TEXT,
    xmlparsed_differences_json TEXT,
    xml_diff_status VARCHAR(50),
    CONSTRAINT fk_run_test_case
        FOREIGN KEY (test_case_id)
        REFERENCES test_cases(idtc)
        ON DELETE CASCADE
);

-------------------------
BEGIN;

-- 1) Drop existing tables (cascade to remove FKs)
DROP TABLE IF EXISTS pod CASCADE;
DROP TABLE IF EXISTS country CASCADE;
DROP TABLE IF EXISTS region CASCADE;

-- 2) Recreate tables (snake_case column names)
CREATE TABLE region (
    id_region    BIGSERIAL PRIMARY KEY,
    region_name  TEXT NOT NULL,
    created_on   TIMESTAMP,
    updated_on   TIMESTAMP,
    is_active    BOOLEAN DEFAULT TRUE
);

CREATE TABLE country (
    id_country   BIGSERIAL PRIMARY KEY,
    country_name TEXT NOT NULL,
    id_region    BIGINT NOT NULL REFERENCES region(id_region) ON DELETE CASCADE,
    created_on   TIMESTAMP,
    updated_on   TIMESTAMP,
    is_active    BOOLEAN DEFAULT TRUE
);

CREATE TABLE pod (
    id_pod       BIGSERIAL PRIMARY KEY,
    pod_name     TEXT NOT NULL,
    id_region    BIGINT NOT NULL REFERENCES region(id_region) ON DELETE CASCADE,
    id_country   BIGINT REFERENCES country(id_country) ON DELETE SET NULL,
    created_on   TIMESTAMP,
    updated_on   TIMESTAMP,
    is_active    BOOLEAN DEFAULT TRUE
);

-- 3) Insert Regions (EMEA, APAC)
INSERT INTO region (region_name, created_on, updated_on, is_active)
VALUES
  ('EMEA', NOW(), NULL, TRUE),
  ('APAC', NOW(), NULL, TRUE);

-- 4) Insert Countries (GB -> EMEA, NZ -> APAC)
INSERT INTO country (country_name, id_region, created_on, updated_on, is_active)
VALUES
  ('GB',  (SELECT id_region FROM region WHERE region_name = 'EMEA' LIMIT 1), NOW(), NULL, TRUE),
  ('NZ',  (SELECT id_region FROM region WHERE region_name = 'APAC' LIMIT 1), NOW(), NULL, TRUE);

-- 5) Insert pods for EMEA -> GB
INSERT INTO pod (pod_name, id_region, id_country, created_on, updated_on, is_active)
VALUES
  ('E1-POD', (SELECT id_region FROM region WHERE region_name = 'EMEA' LIMIT 1), (SELECT id_country FROM country WHERE country_name = 'GB' LIMIT 1), NOW(), NULL, TRUE),
  ('E2-POD', (SELECT id_region FROM region WHERE region_name = 'EMEA' LIMIT 1), (SELECT id_country FROM country WHERE country_name = 'GB' LIMIT 1), NOW(), NULL, TRUE),
  ('S1-POD', (SELECT id_region FROM region WHERE region_name = 'EMEA' LIMIT 1), (SELECT id_country FROM country WHERE country_name = 'GB' LIMIT 1), NOW(), NULL, TRUE),
  ('U1-POD', (SELECT id_region FROM region WHERE region_name = 'EMEA' LIMIT 1), (SELECT id_country FROM country WHERE country_name = 'GB' LIMIT 1), NOW(), NULL, TRUE),
  ('Q1-POD', (SELECT id_region FROM region WHERE region_name = 'EMEA' LIMIT 1), (SELECT id_country FROM country WHERE country_name = 'GB' LIMIT 1), NOW(), NULL, TRUE),
  ('C1-POD', (SELECT id_region FROM region WHERE region_name = 'EMEA' LIMIT 1), (SELECT id_country FROM country WHERE country_name = 'GB' LIMIT 1), NOW(), NULL, TRUE),
  ('C2-POD', (SELECT id_region FROM region WHERE region_name = 'EMEA' LIMIT 1), (SELECT id_country FROM country WHERE country_name = 'GB' LIMIT 1), NOW(), NULL, TRUE),
  ('N1-POD', (SELECT id_region FROM region WHERE region_name = 'EMEA' LIMIT 1), (SELECT id_country FROM country WHERE country_name = 'GB' LIMIT 1), NOW(), NULL, TRUE);

-- 6) Insert pods for APAC -> NZ
INSERT INTO pod (pod_name, id_region, id_country, created_on, updated_on, is_active)
VALUES
  ('A2-POD', (SELECT id_region FROM region WHERE region_name = 'APAC' LIMIT 1), (SELECT id_country FROM country WHERE country_name = 'NZ' LIMIT 1), NOW(), NULL, TRUE),
  ('A3-POD', (SELECT id_region FROM region WHERE region_name = 'APAC' LIMIT 1), (SELECT id_country FROM country WHERE country_name = 'NZ' LIMIT 1), NOW(), NULL, TRUE),
  ('E1-POD', (SELECT id_region FROM region WHERE region_name = 'APAC' LIMIT 1), (SELECT id_country FROM country WHERE country_name = 'NZ' LIMIT 1), NOW(), NULL, TRUE),
  ('Q1-POD', (SELECT id_region FROM region WHERE region_name = 'APAC' LIMIT 1), (SELECT id_country FROM country WHERE country_name = 'NZ' LIMIT 1), NOW(), NULL, TRUE),
  ('E2-POD', (SELECT id_region FROM region WHERE region_name = 'APAC' LIMIT 1), (SELECT id_country FROM country WHERE country_name = 'NZ' LIMIT 1), NOW(), NULL, TRUE),
  ('C2-POD', (SELECT id_region FROM region WHERE region_name = 'APAC' LIMIT 1), (SELECT id_country FROM country WHERE country_name = 'NZ' LIMIT 1), NOW(), NULL, TRUE);

COMMIT;

-- Verification queries (run after commit)

-- Regions
SELECT id_region, region_name, created_on, is_active FROM region ORDER BY id_region;

-- Countries with their region
SELECT c.id_country, c.country_name, c.id_region, r.region_name
FROM country c JOIN region r ON c.id_region = r.id_region
ORDER BY c.id_country;

-- Pods with region & country names
SELECT p.id_pod, p.pod_name, p.id_region, r.region_name AS region, p.id_country, c.country_name AS country
FROM pod p
LEFT JOIN region r ON p.id_region = r.id_region
LEFT JOIN country c ON p.id_country = c.id_country
ORDER BY p.id_pod;

--------------------------